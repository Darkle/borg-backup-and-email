{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./borg.config.json5","webpack:///./index.lsc","webpack:///external \"child_process\"","webpack:///external \"dateformat\"","webpack:///external \"dotenv\"","webpack:///external \"mailgun-js\"","webpack:///external \"node-notifier\"","webpack:///external \"os\"","webpack:///external \"p-reduce\"","webpack:///external \"signal-exit\"","webpack:///external \"util\""],"names":["require","config","exec","Date","os","hostname","domain","process","env","MAILGUN_DOMAIN","apiKey","MAILGUN_PRIVATE_APIKEY","from","to","DESTINATION_EMAIL","options","excludes","exclude","create","repository","prefix","osHostname","date","foldersToBackup","folders","prune","keepDaily","keepWeekly","keepMonthly","log","type","logType","borgCreateParams","push","destination","pExec","join","maxBuffer","Infinity","borgPruneParams","joinExecResultsMessages","catch","identity","then","notify","sendEmail","result","messages","send","mailOptions","subject","generateMessageTitle","generateMessageText","err","console","error","isError","notifier","messageTitle","title","message","Error","param","totalMessage","index","borgAction","stderr","html","JSON","stringify","text","on","bailOnFatalError","exit"],"mappings":"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","file":"index-compiled.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./index.lsc\");\n","module.exports = {\n\t\"create\": {\n\t\t\"options\": [\n\t\t\t\"--stats\",\n\t\t\t\"--show-rc\",\n\t\t\t\"--compression lz4\",\n\t\t\t\"--exclude-caches\"\n\t\t],\n\t\t\"excludes\": [\n\t\t\t\"/home/coop/.ecryptfs/*\",\n\t\t\t\"/home/.ecryptfs/*\",\n\t\t\t\"/home/coop/.cache/*\",\n\t\t\t\"/home/coop/.dbus\",\n\t\t\t\"/home/coop/.local/share/gvfs-metadata/home\",\n\t\t\t\"/home/coop/.gvfs\",\n\t\t\t\"/home/coop/.local/share/recently-used.xbel\"\n\t\t],\n\t\t\"repository\": \"/mnt/Backup2/BorgBackup\",\n\t\t\"prefix\": null,\n\t\t\"foldersToBackup\": [\n\t\t\t\"/home\",\n\t\t\t\"/mnt/1TBInternal/Coding Music\",\n\t\t\t\"/mnt/1TBInternal/DownloadsOn1TB/Coding Tutorials & Books\"\n\t\t],\n\t\t\"showNotification\": true,\n\t\t\"log\": {\n\t\t\t\"type\": \"email\"\n\t\t}\n\t},\n\t\"prune\": {\n\t\t\"options\": [\n\t\t\t\"--show-rc\",\n\t\t\t\"--stats\"\n\t\t],\n\t\t\"repository\": \"/mnt/Backup2/BorgBackup\",\n\t\t\"prefix\": null,\n\t\t\"keepDaily\": 7,\n\t\t\"keepWeekly\": 2,\n\t\t\"keepMonthly\": 1\n\t}\n}","if !process.env.NODE_ENV: process.env.NODE_ENV = \"production\"\nrequire('dotenv').config()\nimport os from 'os'\nimport { promisify } from 'util'\nimport { exec, execFileSync } from 'child_process'\n\nimport dateFormat from 'dateformat'\nimport notifier from 'node-notifier'\nimport mailgunjs from 'mailgun-js'\nimport pReduce from 'p-reduce'\nimport onExit from 'signal-exit'\n\nimport { create, prune } from './borg.config.json5'\n\npExec = promisify(exec)\ndate = dateFormat(new Date(), 'yyyy-mm-dd-HHMMss')\nosHostname = os.hostname()\nmailgun = mailgunjs({\n  domain: process.env.MAILGUN_DOMAIN,\n  apiKey: process.env.MAILGUN_PRIVATE_APIKEY\n})\nmailOptions = {\n  from: 'Borg Backup <borg@localhost.dev>',\n  to: process.env.DESTINATION_EMAIL,\n}\nborgCreateParams = [\n  ...create.options,\n  ...for elem exclude in create.excludes: [ `--exclude \"${ exclude }\"` ],\n  `${ create.repository }::${ create.prefix || osHostname }-${ date }`,\n  ...for elem folders in create.foldersToBackup: [ `\"${ folders }\"` ],\n]\nborgPruneParams = [\n  ...prune.options,\n  `--prefix ${ prune.prefix || osHostname }-`,\n  `--keep-daily ${ prune.keepDaily }`,\n  `--keep-weekly ${ prune.keepWeekly }`,\n  `--keep-monthly ${ prune.keepMonthly }`,\n  prune.repository\n]\nlogType = create.log?.type\n\nif logType === 'file': borgCreateParams.push(` >> \"${ create.log.destination }\" 2>&1`)\n\n/*****\n* Adding large maxBuffer in case of verbose logging and lotsa files.\n*/\npReduce(\n  [\n    pExec(`borg create ${ borgCreateParams.join(' ') }`, {maxBuffer: Infinity})\n    pExec(`borg prune ${ borgPruneParams.join(' ') }`, {maxBuffer: Infinity}),\n  ],\n  joinExecResultsMessages,\n  ''\n)\n.catch(identity)\n.then(notify)\n.then(sendEmail)\n\nsendEmail(result) ->\n  if logType !== 'email': return\n  mailgun.messages().send(\n    {\n      ...mailOptions,\n      subject: generateMessageTitle(result),\n      ...generateMessageText(result)\n    },\n    err -> if err: console.error(err)\n  )\n\nnotify(result) ->\n  messageTitle = generateMessageTitle(result)\n  if !isError(result): notifier.notify(messageTitle)\n  else:\n    notifier.notify({\n      title: messageTitle,\n      message: result?.message\n    })\n  result\n\nisError(err) -> err instanceof Error\nidentity(param) -> param\n\n/*****\n* For some reason the success message arrives in stderr. ¯\\_(ツ)_/¯\n*/\njoinExecResultsMessages(totalMessage, result, index) ->\n  borgAction = if index === 0: 'BACKUP' else: 'PRUNE'\n  return `${ totalMessage }\\n BORG ${ borgAction } RESULTS: \\n${ result.stderr }`\n\n\ngenerateMessageTitle(result) ->\n  if isError(result): 'Borg Backup Encountered An Error 💩'\n  else: 'Borg Backup Completed Successfully 😎'\n\n\ngenerateMessageText(result) ->\n  if isError(result):\n    return { html: `<pre> ${ JSON.stringify(result) } </pre>` }\n  else:\n    { text: result }\n\nonExit(() => {\n  execFileSync('borg', ['break-lock', create.repository])\n})\n\nprocess.on('unhandledRejection', bailOnFatalError)\nprocess.on('uncaughtException', bailOnFatalError)\n\nbailOnFatalError(err):void ->\n  console.error(err)\n  process.exit(1)\n","module.exports = require(\"child_process\");","module.exports = require(\"dateformat\");","module.exports = require(\"dotenv\");","module.exports = require(\"mailgun-js\");","module.exports = require(\"node-notifier\");","module.exports = require(\"os\");","module.exports = require(\"p-reduce\");","module.exports = require(\"signal-exit\");","module.exports = require(\"util\");"],"sourceRoot":""}